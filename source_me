#!/usr/bin/bash
#------------------------------------------------------------------------------
# expects that $TFM_CONFIG_DIR and TFM_CONFIG_NAME are defined
#------------------------------------------------------------------------------

function cleanup() {
    export PATH=$(echo $PATH | sed -r 's!'${TFM_DIR}/bin':*!!')

    unset TFM_LOGDIR
    unset TFM_LOGFILE
    unset TFM_USER_SOURCE_ME_ERRNO
    unset TFM_STANDARD_SOURCEFILE_SOURCED
    unset TFM_TTY
    unset TFM_PORT
}

if [ -n $TFM_VERSION ] ; then echo TFM_VERSION=$TFM_VERSION
                         else echo "TFM not setup, bail out" ; return 1
fi

export TFM_TTY=$(tty | sed -r 's!/dev/!!')

if ! [[ "$TFM_TTY" =~ pts/[0-9]+ ]]; then
    cat<<EOF >&2
WARNING: unable to determine tty. While this will not affect
actual datataking, any DAQInterface launched in this environment
may have problems with sending output to a MessageViewer instance
EOF
fi

source $TFM_CONFIG_DIR/$TFM_CONFIG_NAME/source_me

if [[ -z $ARTDAQ_BASE_PORT           ]]; then export           ARTDAQ_BASE_PORT=10000 ; fi
if [[ -z $ARTDAQ_PORTS_PER_PARTITION ]]; then export ARTDAQ_PORTS_PER_PARTITION=1000  ; fi

source $TFM_DIR/bin/tfm_utils.sh

export TFM_PORT=`tfm_port $ARTDAQ_PARTITION_NUMBER`

export PATH=$TFM_DIR/bin:$PATH

if [[ -n $TFM_SETTINGS ]]; then
    if [[ ! -e $TFM_SETTINGS ]]; then
	      echo "ERROR: the TFM_SETTINGS environment variable doesn't point to a file which exists"
	      cleanup
	      return 1
    fi

    export TFM_SETUP_FHICLCPP=$( dirname $TFM_SETTINGS )/.setup_fhiclcpp

else cat<<EOF
ERROR: the environment variable TFM_SETTINGS hasn't been
defined in $TFM_USER_SOURCE_ME. Please read the DAQInterface
Manual at
https://cdcvs.fnal.gov/redmine/projects/artdaq-utilities/wiki/Artdaq-daqinterface
to learn how to properly set up the DAQInterface environment.
EOF

    cleanup
    return 1
fi
#------------------------------------------------------------------------------
# At this point, set various environment variables DAQInterface needs
# to reasonable defaults if they weren't already set in
# $TFM_USER_SOURCE_ME - or complain if there's no reasonable default
#------------------------------------------------------------------------------
if [ -z $TFM_PROCESS_MANAGEMENT_METHOD ]; then export TFM_PROCESS_MANAGEMENT_METHOD="direct" ; fi

if [[ -z $TFM_FHICL_DIRECTORY ]]; then
    export TFM_FHICL_DIRECTORY="$PWD/simple_test_config"
    cat<<EOF
WARNING: the environment variable TFM_FHICL_DIRECTORY hasn't
been defined in $TFM_USER_SOURCE_ME, so we're going to
assume the default configuration area is $TFM_FHICL_DIRECTORY
EOF
fi

if [[ ! -e "$TFM_FHICL_DIRECTORY" && "$TFM_FHICL_DIRECTORY" != "IGNORED" ]]; then cat<<EOF
ERROR: unable to find the FHiCL directory referred to by the
TFM_FHICL_DIRECTORY environment variable,
$TFM_FHICL_DIRECTORY
EOF
    cleanup
    return 1
fi

if [[ -z $TFM_LOGDIR ]]; then export TFM_LOGDIR=/tmp/tfm_${USER} ; fi

mkdir -p $TFM_LOGDIR
#------------------------------------------------------------------------------
# assume 100 partitions is enough
#------------------------------------------------------------------------------
export TFM_LOGFILE=$TFM_LOGDIR/partition_`printf "%02i" $TFM_PARTITION_NUMBER`.log
cat<<EOF

* The TFM environment setup successful. To launch TFM: tfm_start.sh &
* Output will be logged in ${TFM_LOGDIR}/tfm_partition_<N>.log, 
  where <N> is the partition the TF manager instance is running on

EOF
 
export TFM_STANDARD_SOURCEFILE_SOURCED=true
