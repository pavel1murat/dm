#+startup:fold
* ------------------------------------------------------------------------------
* WORK IN PROGRESS:
* ------------------------------------------------------------------------------
* running interactively    
export TFM_PORT=21000; python $TFM_DIR/rc/control/farm_manager.py -p $TFM_PARTITION_NUMBER --rpc-port $TFM_PORT --config-dir=$TFM_TEST_DIR/demo

* debugging  
python -m pdb farm_manager.py -p 11 --rpc-port=21000 --config-dir=/home/mu2etrk/test_stand/pasha_019/tfm_test/demo
* logfiles of interest: 
- message_facility messages are directed to a process-specific logfile
- by default, cout of all precesses is directed to the PMT log...
- message_facility defaults are generated by artdaq_core/artdaq-core/Utilities/configureMessageFacility.cc
- if $ARTDAQ_LOG_FHICL is defined and the file exists, its contents is appended
- i'm doing that in an inconsistent way
- short term: hack
- longer term : 
#+begin_src
destinations:{
  console:{
    threshold:"INFO" 
    type:"cout"
  } 
  file:{
    append:false 
    directory: "/home/mu2etrk/test_stand/pasha_019/tfm_test/Logs/component01-mu2edaq09-21100" 
    pattern  : "component01-mu2edaq09-21100-%?H%t-%p.log" 
    seperator: "-" 
    threshold: "DEBUG" 
    timestamp_pattern:"%Y%m%d%H%M%S" 
    type:"GenFile"
  } 
  udp:{
    host:"mu2edaq09" 
    port:21005 
    threshold:"DEBUG" 
    type:"UDP"
  }
}
#+end_src
* commands executed on a remote host                                         
['set +C', 
  'echo > /home/mu2etrk/test_stand/pasha_019/tfm_test/Logs/pmt/launch_attempt_mu2edaq09_mu2etrk_partition_11_20231110154104', 
  'export PRODUCTS="/home/mu2etrk/test_stand/pasha_019/remoteProducts_mu2e_v2_06_11_e28_s124_prof"; 
  . /home/mu2etrk/test_stand/pasha_019/remoteProducts_mu2e_v2_06_11_e28_s124_prof/setup >> /home/mu2etrk/test_stand/pasha_019/tfm_test/Logs/pmt/launch_attempt_mu2edaq09_mu2etrk_partition_11_20231110154104 2>&1 ', 
  'upsname=$( which ups 2>/dev/null ); 
  if [[ -n $upsname ]]; then 
    unsetup() { . `$upsname unsetup "$@"` ; }; 
    for pp in `printenv | sed -ne "/^SETUP_/{s/SETUP_//;s/=.*//;p}"`; do 
      test $pp = UPS && continue; 
      prod=`echo $pp | tr "A-Z" "a-z"`; 
      unsetup -j $prod; 
    done; 
    echo "After bash unsetup, products active (should be nothing but ups listed):"; 
    ups active; 
  else 
    echo "ups does not appear to be set up; will not unsetup any products"; 
  fi > /dev/null 2>&1 ', 
  'source /home/mu2etrk/test_stand/pasha_019/setup_ots.sh for_running >> /home/mu2etrk/test_stand/pasha_019/tfm_test/Logs/pmt/launch_attempt_mu2edaq09_mu2etrk_partition_11_20231110154104 2>&1 ', 'export ARTDAQ_LOG_ROOT=/home/mu2etrk/test_stand/pasha_019/tfm_test/Logs', 'export ARTDAQ_LOG_FHICL=/tmp/messagefacility_partition11_mu2etrk.fcl', 'which boardreader >> /home/mu2etrk/test_stand/pasha_019/tfm_test/Logs/pmt/launch_attempt_mu2edaq09_mu2etrk_partition_11_20231110154104 2>&1 ', 
  '/home/mu2etrk/test_stand/pasha_019/srcs/tfm/bin/mopup_shmem.sh 11 --force >> /home/mu2etrk/test_stand/pasha_019/tfm_test/Logs/pmt/launch_attempt_mu2edaq09_mu2etrk_partition_11_20231110154104 2>&1']

* <2023-11-09 Thu> this is what fhichl-cpp part does                         
#+begin_src
['if [[ -z $( command -v fhicl-dump ) ]]; then 
  export PRODUCTS="/home/mu2etrk/test_stand/pasha_019/remoteProducts_mu2e_v2_06_11_e28_s124_prof"; 
  . /home/mu2etrk/test_stand/pasha_019/remoteProducts_mu2e_v2_06_11_e28_s124_prof/setup;upsname=$( which ups 2>/dev/null ); 
  if [[ -n $upsname ]]; then 
    unsetup() { . `$upsname unsetup "$@"` ; }; 
    for pp in `printenv | sed -ne "/^SETUP_/{s/SETUP_//;s/=.*//;p}"`; do 
      test $pp = UPS && continue; 
      prod=`echo $pp | tr "A-Z" "a-z"`; 
      unsetup -j $prod; 
    done; 
    echo "After bash unsetup, products active (should be nothing but ups listed):"; 
    ups active; 
  else echo "ups does not appear to be set up; will not unsetup any products"; 
fi > /dev/null 2>&1 ; 
source /home/mu2etrk/test_stand/pasha_019/tfm_test/.setup_fhiclcpp; fi', 
'if [[ $FHICLCPP_VERSION =~ v4_1[01]|v4_0|v[0123] ]]; then dump_arg=0;else dump_arg=none; fi', 
'fhicl-dump -l $dump_arg -c /home/mu2etrk/test_stand/pasha_019/MessageFacility.fcl']
#+end_src
* TODO move search for message viewer to construction
* TODO move the "boot" actions to early initialization
* TODO config stage includes reloading of the FCL files                      
- normally, don't change anything else from one run to another
* ------------------------------------------------------------------------------
* done items
* ------------------------------------------------------------------------------
* DONE <2023-11-08 Wed> get rid of KNOWN_LIST_OF_BOARDREADERS                
#+begin_src
(Pdb) p daq_comp_list
{'component01': ['localhost', '-1', '1'], 'component02': ['localhost', '-1', '1']}
#+end_src 
- tfm_set_components goes                                                    
- it reads the KNOWN_LIST_OF_BOARDREADERS file, picks up the requested board readers and sends them to to the TF manager
* ------------------------------------------------------------------------------
* back to [[file:tfm.org]]
* ------------------------------------------------------------------------------
