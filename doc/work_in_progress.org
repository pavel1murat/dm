#+startup:fold
* ------------------------------------------------------------------------------
* WORK IN PROGRESS:
* ------------------------------------------------------------------------------
* <2023-12-22 Fri> : tfm_frontend gets all inputs from the ODB, no more fcls 

- the active configuration name is defined in ODB: 

#+begin_src
/Experiment/RunConfigurations/ActiveConfiguration : name of the active configuration
#+end_src

- Each DAQ configuration should have a configuration record defined. 
  The configuration record contains the following fields:
  (start with two, evolve as needed)

#+begin_src
/Experiment/RunConfigurations/$configName : name of the run configuration
  - UseRunInfoDB            : yes - the next run number comes from the PostgreSQL DB
                                    run transitions are recorded in the PostgreSQL DB
                            : no  - DB is not used
  - ARTDAQ_PARTITION_NUMBER : DAQ partition used by the configuration
#+end_src
* running interactively                                                      
export TFM_PORT=21000; python $TFM_DIR/rc/control/farm_manager.py -p $ARTDAQ_PARTITION_NUMBER --rpc-port $TFM_PORT --config-dir=$TFM_CONFIG_DIR/demo

* debugging                                                                  
python -m pdb farm_manager.py -p 11 --rpc-port=21000 --config-dir=/home/mu2etrk/test_stand/pasha_019/tfm_test/demo
* logfiles of interest:                                                      
- message_facility messages are directed to a process-specific logfile
- by default, cout of all precesses is directed to the PMT log...
- message_facility defaults are generated by artdaq_core/artdaq-core/Utilities/configureMessageFacility.cc
- if $ARTDAQ_LOG_FHICL is defined and the file exists, its contents is appended
- i'm doing that in an inconsistent way
- short term: hack
- longer term : 
#+begin_src
destinations:{
  console:{
    threshold:"INFO" 
    type:"cout"
  } 
  file:{
    append:false 
    directory: "/home/mu2etrk/test_stand/pasha_019/tfm_test/Logs/component01-mu2edaq09-21100" 
    pattern  : "component01-mu2edaq09-21100-%?H%t-%p.log" 
    seperator: "-" 
    threshold: "DEBUG" 
    timestamp_pattern:"%Y%m%d%H%M%S" 
    type:"GenFile"
  } 
  udp:{
    host:"mu2edaq09" 
    port:21005 
    threshold:"DEBUG" 
    type:"UDP"
  }
}
#+end_src
* commands executed on a remote host                                         
['set +C', 
  'echo > /home/mu2etrk/test_stand/pasha_019/tfm_test/Logs/pmt/launch_attempt_mu2edaq09_mu2etrk_partition_11_20231110154104', 
  'export PRODUCTS="/home/mu2etrk/test_stand/pasha_019/remoteProducts_mu2e_v2_06_11_e28_s124_prof"; 
  . /home/mu2etrk/test_stand/pasha_019/remoteProducts_mu2e_v2_06_11_e28_s124_prof/setup >> /home/mu2etrk/test_stand/pasha_019/tfm_test/Logs/pmt/launch_attempt_mu2edaq09_mu2etrk_partition_11_20231110154104 2>&1 ', 
  'upsname=$( which ups 2>/dev/null ); 
  if [[ -n $upsname ]]; then 
    unsetup() { . `$upsname unsetup "$@"` ; }; 
    for pp in `printenv | sed -ne "/^SETUP_/{s/SETUP_//;s/=.*//;p}"`; do 
      test $pp = UPS && continue; 
      prod=`echo $pp | tr "A-Z" "a-z"`; 
      unsetup -j $prod; 
    done; 
    echo "After bash unsetup, products active (should be nothing but ups listed):"; 
    ups active; 
  else 
    echo "ups does not appear to be set up; will not unsetup any products"; 
  fi > /dev/null 2>&1 ', 
  'source /home/mu2etrk/test_stand/pasha_019/setup_ots.sh for_running >> /home/mu2etrk/test_stand/pasha_019/tfm_test/Logs/pmt/launch_attempt_mu2edaq09_mu2etrk_partition_11_20231110154104 2>&1 ', 'export ARTDAQ_LOG_ROOT=/home/mu2etrk/test_stand/pasha_019/tfm_test/Logs', 'export ARTDAQ_LOG_FHICL=/tmp/messagefacility_partition11_mu2etrk.fcl', 'which boardreader >> /home/mu2etrk/test_stand/pasha_019/tfm_test/Logs/pmt/launch_attempt_mu2edaq09_mu2etrk_partition_11_20231110154104 2>&1 ', 
  '/home/mu2etrk/test_stand/pasha_019/srcs/tfm/bin/mopup_shmem.sh 11 --force >> /home/mu2etrk/test_stand/pasha_019/tfm_test/Logs/pmt/launch_attempt_mu2edaq09_mu2etrk_partition_11_20231110154104 2>&1']

* <2023-12-02 Sat> submission of artdaq jobs                                 
- it looks that the port number comes under 'id'
#+begin_src                                                                  
artdaq process launch commands to execute on mu2edaq09 (output will be in mu2edaq09:/home/mu2etrk/test_stand/pasha_020/tfm_test/Logs/vst_001/pmt/pmt_000007_mu2edaq09_mu2etrk_partition_08_20231202174649):
set +C
echo 
export PRODUCTS="/home/mu2etrk/test_stand/pasha_020/remoteProducts_mu2e_v2_07_00_e28_s126_debug"; . /home/mu2etrk/test_stand/pasha_020/remoteProducts_mu2e_v2_07_00_e28_s126_debug/setup 
upsname=$( which ups 2>/dev/null ); if [[ -n $upsname ]]; then unsetup() { . `$upsname unsetup "$@"` ; }; for pp in `printenv | sed -ne "/^SETUP_/{s/SETUP_//;s/=.*//;p}"`; do test $pp = UPS && continue; prod=`echo $pp | tr "A-Z" "a-z"`; unsetup -j $prod; done; echo "After bash unsetup, products active (should be nothing but ups listed):"; ups active; else echo "ups does not appear to be set up; will not unsetup any products"; fi > /dev/null 2>&1 
source /home/mu2etrk/test_stand/pasha_020/setup_ots.sh for_running 
export FHICL_FILE_PATH=.:/home/mu2etrk/test_stand/pasha_020/build_slf7.x86_64/otsdaq_mu2e_dqm/slf7.x86_64.e28.s126.debug/fcl:/home/mu2etrk/test_stand/pasha_020/build_slf7.x86_64/otsdaq_mu2e_tracker/slf7.x86_64.e28.s126.debug/fcl:/home/mu2etrk/test_stand/pasha_020/build_slf7.x86_64/otsdaq_mu2e_trigger/slf7.x86_64.e28.s126.debug/fcl:/home/mu2etrk/test_stand/pasha_020/build_slf7.x86_64/artdaq_demo/fcl:/home/mu2etrk/test_stand/pasha_020/build_slf7.x86_64/otsdaq_mu2e/slf7.x86_64.e28.s126.debug/fcl:/home/mu2etrk/test_stand/pasha_020/build_slf7.x86_64/Offline/fcl:/home/mu2etrk/test_stand/pasha_020/build_slf7.x86_64/otsdaq/fcl:/home/mu2etrk/test_stand/pasha_020/build_slf7.x86_64/artdaq_mu2e/fcl:/home/mu2etrk/test_stand/pasha_020/build_slf7.x86_64/artdaq/fcl:/home/mu2etrk/test_stand/pasha_020/build_slf7.x86_64/artdaq_core_mu2e/fcl:/home/mu2etrk/test_stand/pasha_020/build_slf7.x86_64/artdaq_utilities/fcl:/home/mu2etrk/test_stand/pasha_020/remoteProducts_mu2e_v2_07_00_e28_s126_debug/artdaq_epics_plugin/v1_05_06/fcl:/home/mu2etrk/test_stand/pasha_020/remoteProducts_mu2e_v2_07_00_e28_s126_debug/artdaq_mfextensions/v1_08_06/fcl:/home/mu2etrk/test_stand/pasha_020/srcs/otsdaq_mu2e_config/Data_mu2e:/home/mu2etrk/test_stand/pasha_020/srcs/Offline/config:/home/mu2etrk/test_stand/pasha_020/srcs/Offline/config/Offline:/scratch/mu2e/mu2etrk_mu2e_pasha_020/TriggerConfigurations:/home/mu2etrk/test_stand/pasha_020/srcs/otsdaq_mu2e_config/Data_mu2e/OutputData:/mu2e/DataFiles
export ARTDAQ_RUN_NUMBER=7
export ARTDAQ_LOG_ROOT=/home/mu2etrk/test_stand/pasha_020/tfm_test/Logs/vst_001
export ARTDAQ_LOG_FHICL=/tmp/messagefacility_partition8_mu2etrk.fcl
which boardreader 
/home/mu2etrk/test_stand/pasha_020/srcs/tfm/bin/mopup_shmem.sh 8 --force 
taskset --cpu-list "0-63"  boardreader -c "id: 18100 commanderPluginType: xmlrpc rank: 0 application_name: tracker_vst partition_number: 8" &
taskset --cpu-list "0-63"  eventbuilder -c "id: 18101 commanderPluginType: xmlrpc rank: 1 application_name: builder0 partition_number: 8" &
taskset --cpu-list "0-63"  datalogger -c "id: 18102 commanderPluginType: xmlrpc rank: 2 application_name: logger0 partition_number: 8" &
taskset --cpu-list "0-99"  dispatcher -c "id: 10500 commanderPluginType: xmlrpc rank: 3 application_name: dispatcher0 partition_number: 8" &
#+end_src
* <2023-11-09 Thu> this is what fhichl-cpp part does                         
#+begin_src
['if [[ -z $( command -v fhicl-dump ) ]]; then 
  export PRODUCTS="/home/mu2etrk/test_stand/pasha_019/remoteProducts_mu2e_v2_06_11_e28_s124_prof"; 
  . /home/mu2etrk/test_stand/pasha_019/remoteProducts_mu2e_v2_06_11_e28_s124_prof/setup;upsname=$( which ups 2>/dev/null ); 
  if [[ -n $upsname ]]; then 
    unsetup() { . `$upsname unsetup "$@"` ; }; 
    for pp in `printenv | sed -ne "/^SETUP_/{s/SETUP_//;s/=.*//;p}"`; do 
      test $pp = UPS && continue; 
      prod=`echo $pp | tr "A-Z" "a-z"`; 
      unsetup -j $prod; 
    done; 
    echo "After bash unsetup, products active (should be nothing but ups listed):"; 
    ups active; 
  else echo "ups does not appear to be set up; will not unsetup any products"; 
fi > /dev/null 2>&1 ; 
source /home/mu2etrk/test_stand/pasha_019/tfm_test/.setup_fhiclcpp; fi', 
'if [[ $FHICLCPP_VERSION =~ v4_1[01]|v4_0|v[0123] ]]; then dump_arg=0;else dump_arg=none; fi', 
'fhicl-dump -l $dump_arg -c /home/mu2etrk/test_stand/pasha_019/MessageFacility.fcl']
#+end_src
* TODO move search for message viewer to construction
* TODO move the "boot" actions to early initialization
* TODO config stage includes reloading of the FCL files                      
- normally, don't change anything else from one run to another
* ------------------------------------------------------------------------------
* done items
* ------------------------------------------------------------------------------
* DONE <2023-11-08 Wed> get rid of KNOWN_LIST_OF_BOARDREADERS                
#+begin_src
(Pdb) p daq_comp_list
{'component01': ['localhost', '-1', '1'], 'component02': ['localhost', '-1', '1']}
#+end_src 
- tfm_set_components goes                                                    
- it reads the KNOWN_LIST_OF_BOARDREADERS file, picks up the requested board readers and sends them to to the TF manager
* ------------------------------------------------------------------------------
* back to [[file:tfm.org]]
* ------------------------------------------------------------------------------
