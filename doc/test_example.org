#
* running the TFM test example                                               
* 1) initialize the TFM environment                                         
- standard for today's Mu2e DAQ, assume that the current directory is $MRB_TOP
#+begin_src *command output*                                                 
cd $MRB_TOP
mkdir tfm_test
export TFM_TEST_DIR=$MRB_TOP/tfm_test/demo
# cd tfm_test
cp $TFM_DIR/examples/user_source_me    $TFM_TEST_DIR/source_me
cp $TFM_DIR/examples/settings_example  $TFM_TEST_DIR/settings
cp $TFM_DIR/examples/boot.txt          $TFM_TEST_DIR/.
#------------------------------------------------------------------------------
# 1) edit daqinterface_settings
# 2) edit boot.txt to define the setup script
# 3) define environment variables
#------------------------------------------------------------------------------
export TFM_USER_SOURCE_ME=$TFM_TEST_DIR/source_me
export       TFM_SETTINGS=$TFM_TEST_DIR/settings
export              USER=murat                     # need in a docker container
#------------------------------------------------------------------------------
# - use the partition number consistently in ARTDAQ_LOG_FHICL
#------------------------------------------------------------------------------
export TFM_PROCESS_MANAGEMENT_METHOD=direct
export              ARTDAQ_LOG_FHICL=$TFM_TEST_DIR/tmp_fcl/messagefacility_partition_11_murat.fcl
#------------------------------------------------------------------------------
# source $TFM_DIR/source_me (which sources the user source_me, if that one is defined)
#------------------------------------------------------------------------------
source $TFM_DIR/source_me
#+end_src
1.1) make sure that the tfm_test/settings file has everything needed defined
1.2) edit tfm_test/boot.txt to define the DAQ setup script 
* 2) START the TF manager                                                   
- sourcing defines the env var TFM_PORT everywhere - smth to look at 
- FarmManager logs its output to $TFM_LOGFILE
#+begin_src                                                                  
mu2etrk@mu2edaq09:~/test_stand/pasha_019>tfm_start 8 &
[2] 13415
mu2etrk@mu2edaq09:~/test_stand/pasha_019>[tfm_start:19] : $TFM_LOGFILE=/tmp/tfm_mu2etrk/partition_08.log $TFM_PORT=18000
Sun Nov  5 11:10:45 CST 2023: FarmManager in partition 8 launched and now in "stopped" state, listening on port 18000
#+end_src
$TFM_DIR/rc/control/farm_manager.py -p 11 --rpc-port=21000 --config-dir=$TFM_CONFIG_DIR

* 4) BOOT             : tfm_transition boot $PWD/tfm_test/boot.txt          
*** new example
#+begin_src
$TFM_DIR/rc/control/farm_manager.py -p $ARTDAQ_PARTITION_NUMBER --rpc-port=$TFM_PORT --config-dir=$PWD/tfm_test/demo

export TFM_PORT=21000; 
python $TFM_DIR/rc/control/farm_manager.py -p $ARTDAQ_PARTITION_NUMBER --rpc-port $TFM_PORT --config-dir=$TFM_CONFIG_DIR/$TFM_CONFIG_NAME

#+end_src
*** old example
#+begin_src *command output*                                                 
mu2etrk@mu2edaq09:~/test_stand/pasha_019>tfm_transition boot $PWD/tfm_test/boot.txt 
[send_transition.sh:7] : parameters:boot /home/mu2etrk/test_stand/pasha_019/tfm_test/boot.txt
[send_transition.sh:93] full_cmd=xmlrpc http://localhost:18000/RPC2 state_change daqint booting 'struct/{boot_filename:s//home/mu2etrk/test_stand/pasha_019/tfm_test/boot.txt}'
Result:

Nil
mu2etrk@mu2edaq09:~/test_stand/pasha_019>
Sun Nov  5 13:21:44 CST 2023: BOOT transition underway

artdaq_mfextensions v1_08_05, e28:prof:s124, appears to be available; if
windowing is supported on your host you should see the messageviewer
window pop up momentarily

On randomly selected node (localhost), will confirm that the DAQ setup script 
/home/mu2etrk/test_stand/pasha_019/setup_ots.sh
doesn't return a nonzero value when sourced...done (15.8 seconds).

Launching the artdaq processes
Executing commands to launch processes on mu2edaq09
Checking that processes are up (check 1 of a max of 20 checks)...found 6 of 6 processes.
All processes appear to be up

Determining logfiles associated with the artdaq processes...done (0.2 seconds).

Sun Nov  5 13:22:28 CST 2023: BOOT transition complete
#+end_src
4.1) it was specified in $PWD/tfm_test/settings that hashes of artdaq-demo and 
   artdaq need to be saved - that requires artdaq-demo and artdaq-core-demo to be pulled
4.2) need to build artdaq_demo and artdaq_core_demo, as the boardreader plugin used there,  
     generator=ToySimulator, resides in artdaq-demo/Generators
--------------------------------------------------------------------------------
4.3) after the boot, the following processes are running (truncated output of `ps -efl`)
#+begin_src                                                                  
boardreader -c id: 18100 commanderPluginType: xmlrpc rank: 0 application_name: component01 partition_number: 8
boardreader -c id: 18101 commanderPluginType: xmlrpc rank: 1 application_name: component02 partition_number: 8
eventbuilder -c id: 18102 commanderPluginType: xmlrpc rank: 2 application_name: EventBuilder1 partition_number: 8
eventbuilder -c id: 18103 commanderPluginType: xmlrpc rank: 3 application_name: EventBuilder2 partition_number: 8
datalogger -c id: 18104 commanderPluginType: xmlrpc rank: 4 application_name: DataLogger1 partition_number: 8
dispatcher -c id: 18105 commanderPluginType: xmlrpc rank: 5 application_name: Dispatcher1 partition_number: 8
#+end_src
--------------------------------------------------------------------------------
* 5) CONFIG           : tfm_transition config demo                          
- demo is a subdirectory under $TFM_DIR/simple_test_config pointed to by $TFM_FHICL_DIRECTORY
#+begin_src *command output*                                                 
mu2etrk@mu2edaq09:~/test_stand/pasha_019>tfm_transition config demo
[tfm_transition:7] : parameters:config demo
[tfm_transition:93] full_cmd=xmlrpc http://localhost:18000/RPC2 state_change daqint configuring 'struct/{config:array/(s/demo)}'
Result:

Nil
mu2etrk@mu2edaq09:~/test_stand/pasha_019>
Sun Nov  5 14:08:45 CST 2023: CONFIG transition underway
Config name: demo

Obtaining FHiCL documents...done (0.0 seconds).
Reformatting the FHiCL documents...done (0.1 seconds).
Bookkeeping the FHiCL documents...done (0.0 seconds).
Saving the run record...done (10.8 seconds).

Sending init transition to artdaq processes...done (1.2 seconds).

Longest individual transition was EventBuilder1, which took 0.0 seconds.
All artdaq processes returned "Success".

Ensuring FHiCL documents will be archived in the output *.root files...done (0.1 seconds).

Process manager logfiles (if applicable):
/home/mu2etrk/test_stand/pasha_019/tfm_test/Logs/pmt/launch_attempt_mu2edaq09_mu2etrk_partition8_20231105135904

Sun Nov  5 14:08:57 CST 2023: CONFIG transition complete
mu2etrk@mu2edaq09:~/test_stand/pasha_019>artdaq_process_info.sh 8
Result:

String: 
  component01 at mu2edaq09:18100 (subsystem 1, rank 0): Ready\n
  component02 at mu2edaq09:18101 (subsystem 1, rank 1): Ready\n
  EventBuilder1 at mu2edaq09:18102 (subsystem 1, rank 2): Ready\n
  EventBuilder2 at mu2edaq09:18103 (subsystem 1, rank 3): Ready\n
  DataLogger1 at mu2edaq09:18104 (subsystem 1, rank 4): Ready\n
  Dispatcher1 at mu2edaq09:18105 (subsystem 1, rank 5): Ready\n
#+end_src ----------------------------------------------------------------------
* 6) START            : tfm_transition start                                
#+begin_src *command output*                                                 
mu2etrk@mu2edaq09:~/test_stand/pasha_019>tfm_transition start
[tfm_transition:7] : parameters:start
[tfm_transition:93] full_cmd=xmlrpc http://localhost:18000/RPC2 state_change daqint starting 'struct/{run_number:i/1}'
Result:

Nil
mu2etrk@mu2edaq09:~/test_stand/pasha_019>
Sun Nov  5 14:24:04 CST 2023: START transition underway for run 1

Sending start transition to artdaq processes...done (1.4 seconds).

Longest individual transition was EventBuilder1, which took 0.3 seconds.
All artdaq processes returned "Success".


Attempting to provide run-numbered softlinks to the logfiles...done (0.1 seconds).

Run info can be found locally at /home/mu2etrk/test_stand/pasha_019/tfm_test/run_records/1


Sun Nov  5 14:24:06 CST 2023: START transition complete for run 1

mu2etrk@mu2edaq09:~/test_stand/pasha_019>artdaq_process_info.sh 8
Result:

String: 
  component01 at mu2edaq09:18100 (subsystem 1, rank 0): Running\n
  component02 at mu2edaq09:18101 (subsystem 1, rank 1): Running\n
  EventBuilder1 at mu2edaq09:18102 (subsystem 1, rank 2): Running\n
  EventBuilder2 at mu2edaq09:18103 (subsystem 1, rank 3): Running\n
  DataLogger1 at mu2edaq09:18104 (subsystem 1, rank 4): Running\n
  Dispatcher1 at mu2edaq09:18105 (subsystem 1, rank 5): Running\n
#+end_src 
* 7) STOP             : tfm_transition stop                                 
#+begin_src *command output*                                                 
mu2etrk@mu2edaq09:~/test_stand/pasha_019>tfm_transition stop
[tfm_transition:7] : parameters:stop
[tfm_transition:93] full_cmd=xmlrpc http://localhost:18000/RPC2 state_change daqint stopping 'struct/{ignored_variable:i/999}'
Result:

Nil
mu2etrk@mu2edaq09:~/test_stand/pasha_019>
Sun Nov  5 14:27:14 CST 2023: STOP transition underway for run 1

Sending stop transition to artdaq processes...done (6.2 seconds).

Longest individual transition was DataLogger1, which took 2.8 seconds.
All artdaq processes returned "Success".


Sun Nov  5 14:27:21 CST 2023: STOP transition complete for run 1
mu2etrk@mu2edaq09:~/test_stand/pasha_019>artdaq_process_info.sh 8
Result:

String: 
  component01 at mu2edaq09:18100 (subsystem 1, rank 0): Ready\n
  component02 at mu2edaq09:18101 (subsystem 1, rank 1): Ready\n
  EventBuilder1 at mu2edaq09:18102 (subsystem 1, rank 2): Ready\n
  EventBuilder2 at mu2edaq09:18103 (subsystem 1, rank 3): Ready\n
  DataLogger1 at mu2edaq09:18104 (subsystem 1, rank 4): Ready\n
  Dispatcher1 at mu2edaq09:18105 (subsystem 1, rank 5): Ready\n
#+end_src
--------------------------------------------------------------------------------
* 8) SHUTDOWN         : tfm_transition shutdown                             
#+begin_src *command output*                                                 
mu2etrk@mu2edaq09:~/test_stand/pasha_019>tfm_transition shutdown
[tfm_transition:7] : parameters:shutdown
[tfm_transition:93] full_cmd=xmlrpc http://localhost:18000/RPC2 state_change daqint shutting 'struct/{ignored_variable:i/999}'
Result:

Nil
mu2etrk@mu2edaq09:~/test_stand/pasha_019>
Sun Nov  5 14:33:21 CST 2023: SHUTDOWN transition underway

Sending shutdown transition to artdaq processes...done (1.1 seconds).

Longest individual transition was EventBuilder1, which took 0.0 seconds.
All artdaq processes returned "Success".


Sun Nov  5 14:33:22 CST 2023: SHUTDOWN transition complete
Sun Nov  5 14:33:23 CST 2023: Appear to have lost process with label Dispatcher1 on host mu2edaq09

Sun Nov  5 14:33:24 CST 2023: RECOVER transition underway for run 1
Sun Nov  5 14:33:24 CST 2023: Attempting to cleanly wind down the BoardReaders if they (still) exist
Sun Nov  5 14:33:24 CST 2023: Attempting to cleanly wind down the EventBuilders if they (still) exist
Sun Nov  5 14:33:24 CST 2023: Attempting to cleanly wind down the DataLoggers if they (still) exist
Sun Nov  5 14:33:24 CST 2023: Attempting to cleanly wind down the Dispatchers if they (still) exist
Sun Nov  5 14:33:24 CST 2023: Attempting to cleanly wind down the RoutingManagers if they (still) exist
Sun Nov  5 14:33:24 CST 2023: Attempting to kill off the artdaq processes from this run if they still exist

Sun Nov  5 14:33:25 CST 2023: RECOVER transition complete for run 1



"Traceback (most recent call last):   File
"/home/mu2etrk/test_stand/pasha_019/srcs/tfm/rc/control/farm_manager.py",
line 4473, in runner     and self.state(self.name) != "stopped"   File
"/home/mu2etrk/test_stand/pasha_019/srcs/tfm/rc/control/manage_processes_direct.py",
line 901, in check_proc_heartbeats_base     raise Exception( Exception:  Process(es)
"Dispatcher1" died or found in Error state "

FarmManager has set the DAQ back in the "Stopped" state; you may need to
scroll above the Recover transition output to find messages which could
help you provide any necessary adjustments.

Details on how to examine the artdaq process logfiles can be found in the
"Examining your output" section of the FarmManager manual,
https://cdcvs.fnal.gov/redmine/projects/artdaq-utilities/wiki/Artdaq-daqinterface#Examining-your-output
mu2etrk@mu2edaq09:~/test_stand/pasha_019>artdaq_process_info.sh 8
Result:

String: ''
#+end_src
--------------------------------------------------------------------------------
* 9) TERMINATE        : tfm_transition terminate                            
#+begin_src *command output*                                                 
mu2etrk@mu2edaq09:~/test_stand/pasha_019>tfm_transition terminate
[tfm_transition:7] : parameters:terminate
[tfm_transition:93] full_cmd=xmlrpc http://localhost:18000/RPC2 state_change daqint terminating 'struct/{ignored_variable:i/999}'

WARNING: Unable to accept transition request "terminate" from current state "stopped"; the command will have no effect.
Can accept the following transition request(s): boot
Result:

Nil
mu2etrk@mu2edaq09:~/test_stand/pasha_019>
mu2etrk@mu2edaq09:~/test_stand/pasha_019>artdaq_process_info.sh 8
Result:

String: ''
#+end_src
* ------------------------------------------------------------------------------
* back to [[file:tfm.org]]
* ------------------------------------------------------------------------------
